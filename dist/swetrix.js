!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).swetrix={})}(this,(function(t){"use strict";const e=t=>{const e=location.search.match(t);return e&&e[2]||void 0},i=/[?&](ref|source|utm_source|gad_source)=([^?&]+)/,a=/[?&](utm_campaign|gad_campaignid)=([^?&]+)/,n=/[?&](utm_medium)=([^?&]+)/,o=/[?&](utm_term)=([^?&]+)/,r=/[?&](utm_content)=([^?&]+)/,s=/[?&](gclid)=([^?&]+)/,l=()=>"undefined"!=typeof window,c=()=>void 0!==navigator.languages?navigator.languages[0]:navigator.language,d=()=>{try{return Intl.DateTimeFormat().resolvedOptions().timeZone}catch(t){return}},h=()=>document.referrer||void 0,u=()=>e(i),p=()=>e(n)||(e(s)?"<gclid>":void 0),v=()=>e(a),g=()=>e(o),f=()=>e(r),I=t=>{let e=location.pathname||"";if(t.hash){const t=location.hash.indexOf("?");e+=t>-1?location.hash.substring(0,t):location.hash}if(t.search){const t=location.hash.indexOf("?");e+=location.search||(t>-1?location.hash.substring(t):"")}return e},m={stop(){}},E=3e5;class N{constructor(t,e){this.projectID=t,this.options=e,this.pageData=null,this.pageViewsOptions=null,this.errorsOptions=null,this.perfStatsCollected=!1,this.activePage=null,this.errorListenerExists=!1,this.cachedData=null,this.trackPathChange=this.trackPathChange.bind(this),this.heartbeat=this.heartbeat.bind(this),this.captureError=this.captureError.bind(this)}captureError(t){var e,i,a,n;"number"==typeof(null===(e=this.errorsOptions)||void 0===e?void 0:e.sampleRate)&&this.errorsOptions.sampleRate>=Math.random()||this.submitError({filename:t.filename,lineno:t.lineno,colno:t.colno,name:(null===(i=t.error)||void 0===i?void 0:i.name)||"Error",message:(null===(a=t.error)||void 0===a?void 0:a.message)||t.message,stackTrace:null===(n=t.error)||void 0===n?void 0:n.stack},!0)}trackErrors(t){return this.errorListenerExists||!this.canTrack()?m:(this.errorsOptions=t,window.addEventListener("error",this.captureError),this.errorListenerExists=!0,{stop:()=>{window.removeEventListener("error",this.captureError),this.errorListenerExists=!1}})}submitError(t,e){var i,a,n;const o={pid:this.projectID},r={pg:this.activePage||I({hash:null===(i=this.pageViewsOptions)||void 0===i?void 0:i.hash,search:null===(a=this.pageViewsOptions)||void 0===a?void 0:a.search}),lc:c(),tz:d(),...t};if(e&&(null===(n=this.errorsOptions)||void 0===n?void 0:n.callback)){const t=this.errorsOptions.callback(r);if(!1===t)return;t&&"object"==typeof t&&Object.assign(r,t)}Object.assign(r,o),this.sendRequest("error",r)}async track(t){var e,i,a,n;if(!this.canTrack())return;const o={...t,pid:this.projectID,pg:this.activePage||I({hash:null===(e=this.pageViewsOptions)||void 0===e?void 0:e.hash,search:null===(i=this.pageViewsOptions)||void 0===i?void 0:i.search}),lc:c(),tz:d(),ref:h(),so:u(),me:p(),ca:v(),te:g(),co:f(),profileId:null!==(a=t.profileId)&&void 0!==a?a:null===(n=this.options)||void 0===n?void 0:n.profileId};await this.sendRequest("custom",o)}trackPageViews(t){if(!this.canTrack())return m;if(this.pageData)return this.pageData.actions;let e;this.pageViewsOptions=t,(null==t?void 0:t.unique)||(e=setInterval(this.trackPathChange,2e3)),setTimeout(this.heartbeat,3e3);const i=setInterval(this.heartbeat,28e3),a=I({hash:null==t?void 0:t.hash,search:null==t?void 0:t.search});return this.pageData={path:a,actions:{stop:()=>{clearInterval(e),clearInterval(i)}}},this.trackPage(a,null==t?void 0:t.unique),this.pageData.actions}getPerformanceStats(){var t;if(!this.canTrack()||this.perfStatsCollected||!(null===(t=window.performance)||void 0===t?void 0:t.getEntriesByType))return{};const e=window.performance.getEntriesByType("navigation")[0];return e?(this.perfStatsCollected=!0,{dns:e.domainLookupEnd-e.domainLookupStart,tls:e.secureConnectionStart?e.requestStart-e.secureConnectionStart:0,conn:e.secureConnectionStart?e.secureConnectionStart-e.connectStart:e.connectEnd-e.connectStart,response:e.responseEnd-e.responseStart,render:e.domComplete-e.domContentLoadedEventEnd,dom_load:e.domContentLoadedEventEnd-e.responseEnd,page_load:e.loadEventStart,ttfb:e.responseStart-e.requestStart}):{}}async getFeatureFlags(t,e){var i,a,n,o;if(!l())return{};const r=null!==(i=null==t?void 0:t.profileId)&&void 0!==i?i:null===(a=this.options)||void 0===a?void 0:a.profileId;if(!e&&this.cachedData){const t=Date.now();if(this.cachedData.profileId===r&&t-this.cachedData.timestamp<E)return this.cachedData.flags}try{return await this.fetchFlagsAndExperiments(t),(null===(n=this.cachedData)||void 0===n?void 0:n.flags)||{}}catch(t){return console.warn("[Swetrix] Error fetching feature flags:",t),(null===(o=this.cachedData)||void 0===o?void 0:o.flags)||{}}}async fetchFlagsAndExperiments(t){var e,i,a,n;const o=this.getApiBase(),r={pid:this.projectID},s=null!==(e=null==t?void 0:t.profileId)&&void 0!==e?e:null===(i=this.options)||void 0===i?void 0:i.profileId;s&&(r.profileId=s);const l=await fetch(`${o}/feature-flag/evaluate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!l.ok)return void console.warn("[Swetrix] Failed to fetch feature flags and experiments:",l.status);const c=await l.json(),d=null!==(a=null==t?void 0:t.profileId)&&void 0!==a?a:null===(n=this.options)||void 0===n?void 0:n.profileId;this.cachedData={flags:c.flags||{},experiments:c.experiments||{},timestamp:Date.now(),profileId:d}}async getFeatureFlag(t,e,i=!1){var a;return null!==(a=(await this.getFeatureFlags(e))[t])&&void 0!==a?a:i}clearFeatureFlagsCache(){this.cachedData=null}async getExperiments(t,e){var i,a,n,o;if(!l())return{};const r=null!==(i=null==t?void 0:t.profileId)&&void 0!==i?i:null===(a=this.options)||void 0===a?void 0:a.profileId;if(!e&&this.cachedData){const t=Date.now();if(this.cachedData.profileId===r&&t-this.cachedData.timestamp<E)return this.cachedData.experiments}try{return await this.fetchFlagsAndExperiments(t),(null===(n=this.cachedData)||void 0===n?void 0:n.experiments)||{}}catch(t){return console.warn("[Swetrix] Error fetching experiments:",t),(null===(o=this.cachedData)||void 0===o?void 0:o.experiments)||{}}}async getExperiment(t,e,i=null){var a;return null!==(a=(await this.getExperiments(e))[t])&&void 0!==a?a:i}clearExperimentsCache(){this.cachedData=null}async getProfileId(){var t;if(null===(t=this.options)||void 0===t?void 0:t.profileId)return this.options.profileId;if(!l())return null;try{const t=this.getApiBase(),e=await fetch(`${t}/log/profile-id`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pid:this.projectID})});if(!e.ok)return null;return(await e.json()).profileId}catch(t){return null}}async getSessionId(){if(!l())return null;try{const t=this.getApiBase(),e=await fetch(`${t}/log/session-id`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pid:this.projectID})});if(!e.ok)return null;return(await e.json()).sessionId}catch(t){return null}}getApiBase(){var t;return(null===(t=this.options)||void 0===t?void 0:t.apiURL)?this.options.apiURL.replace(/\/log\/?$/,""):"https://api.swetrix.com"}heartbeat(){var t,e;if(!(null===(t=this.pageViewsOptions)||void 0===t?void 0:t.heartbeatOnBackground)&&"hidden"===document.visibilityState)return;const i={pid:this.projectID};(null===(e=this.options)||void 0===e?void 0:e.profileId)&&(i.profileId=this.options.profileId),this.sendRequest("hb",i)}trackPathChange(){var t,e;if(!this.pageData)return;const i=I({hash:null===(t=this.pageViewsOptions)||void 0===t?void 0:t.hash,search:null===(e=this.pageViewsOptions)||void 0===e?void 0:e.search}),{path:a}=this.pageData;a!==i&&this.trackPage(i,!1)}trackPage(t,e=!1){if(!this.pageData)return;this.pageData.path=t;const i=this.getPerformanceStats();this.activePage=t,this.submitPageView({pg:t},e,i,!0)}submitPageView(t,e,i,a){var n,o;const r={pid:this.projectID,perf:i,unique:e},s={lc:c(),tz:d(),ref:h(),so:u(),me:p(),ca:v(),te:g(),co:f(),profileId:null===(n=this.options)||void 0===n?void 0:n.profileId,...t};if(a&&(null===(o=this.pageViewsOptions)||void 0===o?void 0:o.callback)){const t=this.pageViewsOptions.callback(s);if(!1===t)return;t&&"object"==typeof t&&Object.assign(s,t)}Object.assign(s,r),this.sendRequest("",s)}canTrack(){var t,e,i,a;return!((null===(t=this.options)||void 0===t?void 0:t.disabled)||!l()||(null===(e=this.options)||void 0===e?void 0:e.respectDNT)&&"1"===(null===(i=window.navigator)||void 0===i?void 0:i.doNotTrack)||!(null===(a=this.options)||void 0===a?void 0:a.devMode)&&("localhost"===(null===location||void 0===location?void 0:location.hostname)||"127.0.0.1"===(null===location||void 0===location?void 0:location.hostname)||""===(null===location||void 0===location?void 0:location.hostname))||(null===navigator||void 0===navigator?void 0:navigator.webdriver))}async sendRequest(t,e){var i;const a=(null===(i=this.options)||void 0===i?void 0:i.apiURL)||"https://api.swetrix.com/log";await fetch(`${a}/${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}}t.LIB_INSTANCE=null,t.clearExperimentsCache=function(){t.LIB_INSTANCE&&t.LIB_INSTANCE.clearExperimentsCache()},t.clearFeatureFlagsCache=function(){t.LIB_INSTANCE&&t.LIB_INSTANCE.clearFeatureFlagsCache()},t.getExperiment=async function(e,i,a=null){return t.LIB_INSTANCE?t.LIB_INSTANCE.getExperiment(e,i,a):a},t.getExperiments=async function(e,i){return t.LIB_INSTANCE?t.LIB_INSTANCE.getExperiments(e,i):{}},t.getFeatureFlag=async function(e,i,a=!1){return t.LIB_INSTANCE?t.LIB_INSTANCE.getFeatureFlag(e,i,a):a},t.getFeatureFlags=async function(e,i){return t.LIB_INSTANCE?t.LIB_INSTANCE.getFeatureFlags(e,i):{}},t.getProfileId=async function(){return t.LIB_INSTANCE?t.LIB_INSTANCE.getProfileId():null},t.getSessionId=async function(){return t.LIB_INSTANCE?t.LIB_INSTANCE.getSessionId():null},t.init=function(e,i){return t.LIB_INSTANCE||(t.LIB_INSTANCE=new N(e,i)),t.LIB_INSTANCE},t.pageview=function(e){t.LIB_INSTANCE&&t.LIB_INSTANCE.submitPageView(e.payload,Boolean(e.unique),{})},t.track=async function(e){t.LIB_INSTANCE&&await t.LIB_INSTANCE.track(e)},t.trackError=function(e){t.LIB_INSTANCE&&t.LIB_INSTANCE.submitError(e,!1)},t.trackErrors=function(e){return t.LIB_INSTANCE?t.LIB_INSTANCE.trackErrors(e):m},t.trackPageview=function(e,i,a){t.LIB_INSTANCE&&t.LIB_INSTANCE.submitPageView({pg:e},Boolean(a),{})},t.trackViews=function(e){return new Promise((i=>{t.LIB_INSTANCE?"undefined"==typeof document||"complete"===document.readyState?i(t.LIB_INSTANCE.trackPageViews(e)):window.addEventListener("load",(()=>{i(t.LIB_INSTANCE.trackPageViews(e))})):i(m)}))}}));
//# sourceMappingURL=swetrix.js.map
