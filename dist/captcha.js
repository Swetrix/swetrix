!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";const e="http://localhost:5005/v1/captcha",t=1e8,o=3e5,n="/generate",r="/verify";var a,i;!function(e){e.SUCCESS="success",e.FAILURE="failure",e.TOKEN_EXPIRED="tokenExpired"}(a||(a={})),function(e){e.checkbox="checkbox",e.failure="failure",e.completed="completed",e.loading="loading"}(i||(i={}));let c=i.checkbox,l=null;const s=(e,t={})=>{window.parent.postMessage({event:e,type:"swetrix-captcha",cid:window.__SWETRIX_CAPTCHA_ID,...t},"*")},d=e=>{var t,o,n,r,a;c=e;const l=document.querySelector("#status-default"),s=document.querySelector("#status-failure"),d=document.querySelector("#status-computing"),u={checkbox:document.querySelector("#checkbox"),failure:document.querySelector("#failure"),completed:document.querySelector("#completed"),loading:document.querySelector("#loading")};e!==i.checkbox?null===(t=u.checkbox)||void 0===t||t.classList.add("fade-out"):null===(o=u.checkbox)||void 0===o||o.classList.remove("fade-out"),null===(n=u.loading)||void 0===n||n.classList.remove("show"),null===(r=u.failure)||void 0===r||r.classList.remove("show"),null===(a=u.completed)||void 0===a||a.classList.remove("show"),null==l||l.classList.add("hidden"),null==s||s.classList.add("hidden"),null==d||d.classList.add("hidden"),"failure"===e?null==s||s.classList.remove("hidden"):"loading"===e?null==d||d.classList.remove("hidden"):null==l||l.classList.remove("hidden"),e!==i.checkbox&&requestAnimationFrame(()=>{var t;null===(t=u[e])||void 0===t||t.classList.add("show")})},u=()=>{setTimeout(()=>{s(a.TOKEN_EXPIRED),d(i.checkbox)},3e5)},f=async(t,o,n)=>{try{const a=await fetch(`${e}${r}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challenge:t,nonce:o,solution:n,pid:window.__SWETRIX_PROJECT_ID})});if(!a.ok)throw new Error("Verification failed");const i=await a.json();if(!i.success)throw new Error("Verification failed");return i.token}catch(e){return s(a.FAILURE),d(i.failure),null}},m=async e=>{const{challenge:n,difficulty:r}=e;let c=0;const l=Date.now(),m=async e=>{const t=(new TextEncoder).encode(e),o=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(o)).map(e=>e.toString(16).padStart(2,"0")).join("")},h=(e,t)=>{for(let o=0;o<t;o++)if("0"!==e[o])return!1;return!0};for(;c<t;){if(Date.now()-l>=o)return console.error(`PoW main-thread timeout: 300000ms elapsed after ${c} attempts`),s(a.FAILURE),void d(i.failure);const e=`${n}:${c}`,t=await m(e);if(h(t,r)){const e=await f(n,c,t);return void(e&&(s(a.SUCCESS,{token:e}),u(),d(i.completed)))}c++}console.error("PoW main-thread max iterations reached: 100000000 attempts"),s(a.FAILURE),d(i.failure)};document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelector("#swetrix-captcha"),o=document.querySelector("#branding");null==o||o.addEventListener("click",e=>{e.stopPropagation()}),null==t||t.addEventListener("click",async()=>{if(c===i.loading||c===i.completed)return;if(c===i.failure)return void d(i.checkbox);d(i.loading);const t=await(async()=>{try{const t=await fetch(`${e}${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pid:window.__SWETRIX_PROJECT_ID})});if(!t.ok)throw new Error("Failed to generate challenge");return await t.json()}catch(e){return s(a.FAILURE),d(i.failure),null}})();t&&await(async e=>new Promise((t,o)=>{l&&l.terminate();try{l=new Worker("./pow-worker.js")}catch(n){return void m(e).then(t).catch(o)}l.onmessage=async o=>{const n=o.data;if("progress"!==n.type){if("timeout"===n.type)return console.error("PoW worker timeout:",n.reason),s(a.FAILURE),d(i.failure),null==l||l.terminate(),l=null,void t();if("result"===n.type){const o=await f(e.challenge,n.nonce,n.solution);return o&&(s(a.SUCCESS,{token:o}),u(),d(i.completed)),null==l||l.terminate(),l=null,void t()}if("error"===n.type){const e=n;return console.error("PoW worker error message:",e.message||"Unknown error"),s(a.FAILURE),d(i.failure),null==l||l.terminate(),l=null,void t()}console.warn("PoW worker received unexpected message type:",n.type,"Raw data:",n),s(a.FAILURE),d(i.failure),null==l||l.terminate(),l=null,t()}},l.onerror=n=>{console.error("PoW worker error:",n),null==l||l.terminate(),l=null,m(e).then(t).catch(o)},l.postMessage({challenge:e.challenge,difficulty:e.difficulty})}))(t)})})});
//# sourceMappingURL=captcha.js.map
