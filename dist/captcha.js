!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";const e=window.__SWETRIX_CAPTCHA_DEV||!1,t=e?"http://localhost:5005/v1/captcha":"https://api.swetrix.com/v1/captcha",o=e?"./pow-worker.js":"https://cap.swetrix.com/pow-worker.js",n=1e8,r=3e5,a="/generate",i="/verify";var c,l;!function(e){e.SUCCESS="success",e.FAILURE="failure",e.TOKEN_EXPIRED="tokenExpired"}(c||(c={})),function(e){e.checkbox="checkbox",e.failure="failure",e.completed="completed",e.loading="loading"}(l||(l={}));let s=l.checkbox,d=null;const u=(e,t={})=>{window.parent.postMessage({event:e,type:"swetrix-captcha",cid:window.__SWETRIX_CAPTCHA_ID,...t},"*")},f=e=>{var t,o,n,r,a;s=e;const i=document.querySelector("#status-default"),c=document.querySelector("#status-failure"),d=document.querySelector("#status-computing"),u={checkbox:document.querySelector("#checkbox"),failure:document.querySelector("#failure"),completed:document.querySelector("#completed"),loading:document.querySelector("#loading")};e!==l.checkbox?null===(t=u.checkbox)||void 0===t||t.classList.add("fade-out"):null===(o=u.checkbox)||void 0===o||o.classList.remove("fade-out"),null===(n=u.loading)||void 0===n||n.classList.remove("show"),null===(r=u.failure)||void 0===r||r.classList.remove("show"),null===(a=u.completed)||void 0===a||a.classList.remove("show"),null==i||i.classList.add("hidden"),null==c||c.classList.add("hidden"),null==d||d.classList.add("hidden"),"failure"===e?null==c||c.classList.remove("hidden"):"loading"===e?null==d||d.classList.remove("hidden"):null==i||i.classList.remove("hidden"),e!==l.checkbox&&requestAnimationFrame(()=>{var t;null===(t=u[e])||void 0===t||t.classList.add("show")})},m=()=>{setTimeout(()=>{u(c.TOKEN_EXPIRED),f(l.checkbox)},3e5)},h=async(e,o,n)=>{try{const r=await fetch(`${t}${i}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challenge:e,nonce:o,solution:n,pid:window.__SWETRIX_PROJECT_ID})});if(!r.ok)throw new Error("Verification failed");const a=await r.json();if(!a.success)throw new Error("Verification failed");return a.token}catch(e){return u(c.FAILURE),f(l.failure),null}},w=async e=>{const{challenge:t,difficulty:o}=e;let a=0;const i=Date.now(),s=async e=>{const t=(new TextEncoder).encode(e),o=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(o)).map(e=>e.toString(16).padStart(2,"0")).join("")},d=(e,t)=>{for(let o=0;o<t;o++)if("0"!==e[o])return!1;return!0};for(;a<n;){if(Date.now()-i>=r)return console.error(`PoW main-thread timeout: 300000ms elapsed after ${a} attempts`),u(c.FAILURE),void f(l.failure);const e=`${t}:${a}`,n=await s(e);if(d(n,o)){const e=await h(t,a,n);return void(e&&(u(c.SUCCESS,{token:e}),m(),f(l.completed)))}a++}console.error("PoW main-thread max iterations reached: 100000000 attempts"),u(c.FAILURE),f(l.failure)};document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("#swetrix-captcha"),n=document.querySelector("#branding");null==n||n.addEventListener("click",e=>{e.stopPropagation()}),null==e||e.addEventListener("click",async()=>{if(s===l.loading||s===l.completed)return;if(s===l.failure)return void f(l.checkbox);f(l.loading);const e=await(async()=>{try{const e=await fetch(`${t}${a}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pid:window.__SWETRIX_PROJECT_ID})});if(!e.ok)throw new Error("Failed to generate challenge");return await e.json()}catch(e){return u(c.FAILURE),f(l.failure),null}})();e&&await(async e=>new Promise((t,n)=>{d&&d.terminate();try{d=new Worker(o)}catch(o){return void w(e).then(t).catch(n)}d.onmessage=async o=>{const n=o.data;if("progress"!==n.type){if("timeout"===n.type)return console.error("PoW worker timeout:",n.reason),u(c.FAILURE),f(l.failure),null==d||d.terminate(),d=null,void t();if("result"===n.type){const o=await h(e.challenge,n.nonce,n.solution);return o&&(u(c.SUCCESS,{token:o}),m(),f(l.completed)),null==d||d.terminate(),d=null,void t()}if("error"===n.type){const e=n;return console.error("PoW worker error message:",e.message||"Unknown error"),u(c.FAILURE),f(l.failure),null==d||d.terminate(),d=null,void t()}console.warn("PoW worker received unexpected message type:",n.type,"Raw data:",n),u(c.FAILURE),f(l.failure),null==d||d.terminate(),d=null,t()}},d.onerror=o=>{console.error("PoW worker error:",o),null==d||d.terminate(),d=null,w(e).then(t).catch(n)},d.postMessage({challenge:e.challenge,difficulty:e.difficulty})}))(e)})})});
//# sourceMappingURL=captcha.js.map
