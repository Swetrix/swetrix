!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";const e=window.__SWETRIX_CAPTCHA_DEV||!1,t=e?"http://localhost:5005/v1/captcha":"https://api.swetrixcaptcha.com/v1/captcha",r=window.__SWETRIX_API_URL||t,a=e?"./pow-worker.js":"https://cdn.swetrixcaptcha.com/pow-worker.js",o=1e8,i=3e5,n="/generate",s="/verify";var c,l;!function(e){e.SUCCESS="success",e.FAILURE="failure",e.TOKEN_EXPIRED="tokenExpired"}(c||(c={})),function(e){e.checkbox="checkbox",e.failure="failure",e.completed="completed",e.loading="loading"}(l||(l={}));let u=l.checkbox,d=null;const h=(e,t={})=>{window.parent.postMessage({event:e,type:"swetrix-captcha",cid:window.__SWETRIX_CAPTCHA_ID,...t},"*")},f=e=>{const t=document.querySelector("#progress-bar-container"),r=document.querySelector("#progress-bar");t&&r&&(e<0?(t.classList.add("show"),r.classList.add("indeterminate"),r.style.width="",t.setAttribute("aria-valuenow","0"),t.removeAttribute("aria-valuenow")):0===e?(t.classList.remove("show"),r.classList.remove("indeterminate"),r.style.width="0%",t.setAttribute("aria-valuenow","0")):e>=100?(r.classList.remove("indeterminate"),r.style.width="100%",t.setAttribute("aria-valuenow","100"),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{r.style.width="0%"},300)},400)):(t.classList.add("show"),r.classList.remove("indeterminate"),r.style.width=`${Math.min(e,95)}%`,t.setAttribute("aria-valuenow",String(Math.round(e)))))},m=e=>{const t=document.querySelector("#swetrix-captcha");if(!t)return;switch(e){case l.checkbox:t.setAttribute("role","checkbox"),t.setAttribute("aria-checked","false"),t.setAttribute("aria-busy","false"),t.setAttribute("aria-label","Human verification checkbox. Press Enter or Space to verify you are human.");break;case l.loading:t.setAttribute("role","status"),t.setAttribute("aria-checked","mixed"),t.setAttribute("aria-busy","true"),t.setAttribute("aria-label","Verifying that you are human. Please wait.");break;case l.completed:t.setAttribute("role","checkbox"),t.setAttribute("aria-checked","true"),t.setAttribute("aria-busy","false"),t.setAttribute("aria-label","Verification successful. You have been verified as human.");break;case l.failure:t.setAttribute("role","checkbox"),t.setAttribute("aria-checked","false"),t.setAttribute("aria-busy","false"),t.setAttribute("aria-label","Verification failed. Press Enter or Space to try again.")}const r=document.querySelector("#sr-status");if(r)switch(e){case l.loading:r.textContent="Verification in progress. Please wait.";break;case l.completed:r.textContent="Verification successful!";break;case l.failure:r.textContent="Verification failed. Please try again.";break;default:r.textContent=""}},w=e=>{var t,r,a,o,i;u=e;const n=document.querySelector("#status-default"),s=document.querySelector("#status-failure"),c=document.querySelector("#status-computing"),d={checkbox:document.querySelector("#checkbox"),failure:document.querySelector("#failure"),completed:document.querySelector("#completed"),loading:document.querySelector("#loading")};e!==l.checkbox?null===(t=d.checkbox)||void 0===t||t.classList.add("fade-out"):null===(r=d.checkbox)||void 0===r||r.classList.remove("fade-out"),null===(a=d.loading)||void 0===a||a.classList.remove("show"),null===(o=d.failure)||void 0===o||o.classList.remove("show"),null===(i=d.completed)||void 0===i||i.classList.remove("show"),null==n||n.classList.add("hidden"),null==s||s.classList.add("hidden"),null==c||c.classList.add("hidden"),"failure"===e?(null==s||s.classList.remove("hidden"),f(0)):"loading"===e?(null==c||c.classList.remove("hidden"),f(-1)):"completed"===e?(null==n||n.classList.remove("hidden"),f(100)):(null==n||n.classList.remove("hidden"),f(0)),e!==l.checkbox&&requestAnimationFrame(()=>{var t;null===(t=d[e])||void 0===t||t.classList.add("show")}),m(e)},p=()=>{setTimeout(()=>{h(c.TOKEN_EXPIRED),w(l.checkbox)},3e5)},y=async(e,t,a)=>{try{const o=await fetch(`${r}${s}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challenge:e,nonce:t,solution:a,pid:window.__SWETRIX_PROJECT_ID})});if(!o.ok)throw new Error("Verification failed");const i=await o.json();if(!i.success)throw new Error("Verification failed");return i.token}catch(e){return h(c.FAILURE),w(l.failure),null}},b=(e,t)=>{const r=e/(Math.pow(16,t)/2)*100;return Math.min(95,10*Math.sqrt(r))},v=async e=>{const{challenge:t,difficulty:r}=e;let a=0;const n=Date.now(),s=async e=>{const t=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map(e=>e.toString(16).padStart(2,"0")).join("")},u=(e,t)=>{for(let r=0;r<t;r++)if("0"!==e[r])return!1;return!0};for(;a<o;){if(Date.now()-n>=i)return console.error(`PoW main-thread timeout: 300000ms elapsed after ${a} attempts`),h(c.FAILURE),void w(l.failure);const e=`${t}:${a}`,o=await s(e);if(u(o,r)){f(100);const e=await y(t,a,o);return void(e&&(h(c.SUCCESS,{token:e}),p(),w(l.completed)))}if(a++,a%1e3==0){const e=b(a,r);f(e)}}console.error("PoW main-thread max iterations reached: 100000000 attempts"),h(c.FAILURE),w(l.failure)},k=async()=>{if(u===l.loading||u===l.completed)return;if(u===l.failure)return void w(l.checkbox);w(l.loading);const e=await(async()=>{try{const e=await fetch(`${r}${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pid:window.__SWETRIX_PROJECT_ID})});if(!e.ok)throw new Error("Failed to generate challenge");return await e.json()}catch(e){return h(c.FAILURE),w(l.failure),null}})();e&&await(async e=>new Promise((t,r)=>{d&&d.terminate();try{d=new Worker(a)}catch(a){return void v(e).then(t).catch(r)}d.onmessage=async r=>{const a=r.data;if("progress"===a.type){const t=b(a.attempts,e.difficulty);return void f(t)}if("timeout"===a.type)return console.error("PoW worker timeout:",a.reason),h(c.FAILURE),w(l.failure),null==d||d.terminate(),d=null,void t();if("result"===a.type){f(100);const r=await y(e.challenge,a.nonce,a.solution);return r&&(h(c.SUCCESS,{token:r}),p(),w(l.completed)),null==d||d.terminate(),d=null,void t()}if("error"===a.type){const e=a;return console.error("PoW worker error message:",e.message||"Unknown error"),h(c.FAILURE),w(l.failure),null==d||d.terminate(),d=null,void t()}console.warn("PoW worker received unexpected message type:",a.type,"Raw data:",a),h(c.FAILURE),w(l.failure),null==d||d.terminate(),d=null,t()},d.onerror=a=>{console.error("PoW worker error:",a),null==d||d.terminate(),d=null,v(e).then(t).catch(r)},d.postMessage({challenge:e.challenge,difficulty:e.difficulty})}))(e)};document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("#swetrix-captcha"),t=document.querySelector("#branding");null==t||t.addEventListener("click",e=>{e.stopPropagation()}),null==e||e.addEventListener("click",k),null==e||e.addEventListener("keydown",e=>{const t=e;"Enter"!==t.key&&" "!==t.key||(e.preventDefault(),k())}),null==e||e.addEventListener("keyup",e=>{" "===e.key&&e.preventDefault()}),m(l.checkbox)})});
//# sourceMappingURL=captcha.js.map
